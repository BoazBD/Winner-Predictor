{% extends "base.html" %}

{% block content %}
<!-- Debug info -->
{# The following debug div block will be removed #}
{# <div class="alert alert-info d-none">
    Total games: {{ games|length }}
    Primary games: {{ games|selectattr("is_primary", "defined")|selectattr("is_primary")|list|length }}
    Non-primary games: {{ games|selectattr("is_primary", "defined")|rejectattr("is_primary")|list|length }}
</div> #}

<div class="row mb-4">
    <div class="col">
        <h1 class="display-5 text-primary">All Predictions</h1>
        <p class="lead text-muted">Complete list of all AI-powered sports betting predictions</p>
        <a href="/" class="btn btn-outline-primary mb-3">Back to Profitable Predictions</a>
    </div>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="accordion mb-4" id="filterAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header" id="filterHeader">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#filterContent" aria-expanded="true" aria-controls="filterContent">
                        <strong><i class="bi bi-funnel-fill me-2"></i>Filter Options</strong>
                    </button>
                </h2>
                <div id="filterContent" class="accordion-collapse collapse show" aria-labelledby="filterHeader">
                    <div class="accordion-body p-3">
                <form id="filterForm" method="GET" action="/all">
                            <div class="mb-2">
                                <label class="form-label small fw-bold">League</label>
                                <select class="form-select form-select-sm" name="league">
                            <option value="">All Leagues</option>
                            {% for league in leagues %}
                            <option value="{{ league }}" {% if selected_league == league %}selected{% endif %}>{{ league }}</option>
                            {% endfor %}
                        </select>
                    </div>
                            <div class="mb-2">
                                <label class="form-label small fw-bold">Model Type</label>
                        <div class="dropdown model-dropdown">
                                    <button class="btn btn-sm btn-outline-primary dropdown-toggle w-100 d-flex justify-content-between align-items-center" 
                                    type="button" id="modelFilterDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <span>
                                    {% if selected_model %}
                                        {{ selected_model }}
                                    {% else %}
                                        All Models
                                    {% endif %}
                                </span>
                                <i class="bi bi-chevron-down ms-2"></i>
                            </button>
                            <ul class="dropdown-menu w-100" aria-labelledby="modelFilterDropdown">
                                <li><a class="dropdown-item model-item {% if selected_model == '' %}active{% endif %}" href="javascript:void(0)" data-value="">All Models</a></li>
                                <li><hr class="dropdown-divider"></li>
                                {% for model in model_types %}
                                <li><a class="dropdown-item model-item {% if selected_model == model %}active{% endif %}" href="javascript:void(0)" data-value="{{ model }}">{{ model }}</a></li>
                                {% endfor %}
                            </ul>
                            <input type="hidden" name="model_type" id="modelTypeInput" value="{{ selected_model }}">
                        </div>
                    </div>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <label class="form-label small fw-bold">Prediction</label>
                                    <select class="form-select form-select-sm" name="prediction_type">
                                        <option value="">All</option>
                            <option value="Home Win" {% if selected_prediction == 'Home Win' %}selected{% endif %}>Home Win</option>
                            <option value="Draw" {% if selected_prediction == 'Draw' %}selected{% endif %}>X</option>
                            <option value="Away Win" {% if selected_prediction == 'Away Win' %}selected{% endif %}>Away Win</option>
                        </select>
                    </div>
                                <div class="col-6">
                                    <label class="form-label small fw-bold">Status</label>
                                    <select class="form-select form-select-sm" name="status">
                                        <option value="">All</option>
                            <option value="upcoming" {% if selected_status == 'upcoming' %}selected{% endif %}>Upcoming</option>
                            <option value="completed" {% if selected_status == 'completed' %}selected{% endif %}>Completed</option>
                        </select>
                    </div>
                            </div>
                            <div class="row mb-2">
                                <div class="col-6">
                                    <label class="form-label small fw-bold">Result</label>
                                    <select class="form-select form-select-sm" name="result">
                                        <option value="">All</option>
                            <option value="correct" {% if selected_result == 'correct' %}selected{% endif %}>Correct</option>
                            <option value="incorrect" {% if selected_result == 'incorrect' %}selected{% endif %}>Incorrect</option>
                        </select>
                    </div>
                                <div class="col-6">
                                    <label class="form-label small fw-bold">EV</label>
                                    <select class="form-select form-select-sm" name="ev">
                                        <option value="">All</option>
                                        <option value="high" {% if selected_ev == 'high' %}selected{% endif %}>High</option>
                                        <option value="medium" {% if selected_ev == 'medium' %}selected{% endif %}>Medium</option>
                                        <option value="low" {% if selected_ev == 'low' %}selected{% endif %}>Low</option>
                        </select>
                                </div>
                            </div>
                            
                            <!-- Hidden language parameter -->
                            <input type="hidden" name="lang" value="{{ selected_language|default('english') }}">
                            
                            <div class="d-grid gap-2 mt-3">
                                <button type="submit" class="btn btn-sm btn-primary">Apply Filters</button>
                                <a href="/all?model_type=lstm_100_12_v1" class="btn btn-sm btn-outline-secondary">Reset Filters</a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-9">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <h2 class="fs-4 mb-0 text-primary">All Predictions</h2>
                <p class="small text-muted mb-0">Sorted by newest predictions first</p>
            </div>
            <div class="prediction-count badge bg-dark text-white rounded-pill fs-6 py-2 px-3">
                <i class="bi bi-list-check me-1"></i>
                {% if games is defined and games %}
                    {% if total_count is defined and total_count > 0 %}
                        {{ games|length }} of {{ total_count }} games
                    {% else %}
                        {{ games|length }} games
                    {% endif %}
                {% else %}
                    No games found
                {% endif %}
            </div>
        </div>
        
        <!-- Loading spinner -->
        {% if loading %}
        <div id="loading-spinner" class="text-center my-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-3">Loading predictions...</p>
        </div>
        {% endif %}
        
        <!-- Error message if needed -->
        {% if error %}
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            Error loading predictions. Please try again later.
            <small class="d-none">{{ error }}</small>
        </div>
        {% endif %}
        
        <div id="predictions-container">
            {% if games %}
                {% for game in games %}
                    <div class="card prediction-card {% if game.status == 'completed' %}{% if game.prediction_result == true %}prediction-correct{% elif game.prediction_result == false %}prediction-incorrect{% endif %}{% endif %} mb-3">
                        <div class="card-header bg-light py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <!-- Left side: League and Time -->
                                <div class="d-flex align-items-center">
                                    <span class="league-badge badge bg-secondary me-2">
                            <i class="bi bi-trophy me-1"></i>
                                        {{ game.display_league|default(game.league|default('Unknown League')) }}
                        </span>
                                    <span class="match-time badge bg-light text-dark border">
                            <i class="bi bi-calendar-event me-1"></i>
                                        {{ game.match_time.strftime('%Y-%m-%d') }} 
                                        <strong>{{ game.match_time.strftime('%H:%M') }}</strong>
                        </span>
                                </div>
                                <!-- Right side: Model and Result Badge -->
                                <div class="d-flex align-items-center">
                                    <div class="model-badge me-2">
                            <i class="bi bi-robot me-1"></i>
                                        <span class="fw-medium small">{{ game.model_name|default('Unknown Model') }}</span>
                                    </div>
                                    {% if game.status == 'completed' %}
                                        {% if game.prediction_result == true %}
                                            <span class="result-badge bg-success"><i class="bi bi-check-circle me-1"></i> Correct</span>
                                        {% elif game.prediction_result == false %}
                                            <span class="result-badge bg-danger"><i class="bi bi-x-circle me-1"></i> Incorrect</span>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="card-body py-3">
                            <div class="row">
                                <!-- Teams and odds section -->
                                <div class="col-md-5">
                                    <div class="match-teams-container mb-3">
                                        <div class="d-flex justify-content-between align-items-center teams-display">
                                            <!-- Home Team -->
                                            <div class="team-column text-center">
                                                <div class="team-badge {% if game.home_win_is_profitable %}active-prediction{% endif %}">
                                                    <div class="team-name fw-bold mb-2" data-short="{{ 'true' if game.display_home_team|default(game.home_team|default('Home Team'))|length <= 15 else 'false' }}">{{ game.display_home_team|default(game.home_team|default('Home Team')) }}</div>
                                                    <div class="odds-badge {% if game.home_win_is_profitable %}highlighted-odds{% endif %}">
                                                        {% if game.odds.home is not none %}{{ game.odds.home }}{% else %}-{% endif %}
                                                    </div>
                                                </div>
                                                <div class="outcome-label">Home</div>
                                            </div>
                                            
                                            <!-- Draw Column -->
                                            <div class="team-column text-center mx-2">
                                                <div class="team-badge {% if game.draw_is_profitable %}active-prediction{% endif %}">
                                                    <div class="team-name fw-bold mb-2" data-short="true">X</div>
                                                    <div class="odds-badge {% if game.draw_is_profitable %}highlighted-odds{% endif %}">
                                                        {% if game.odds.draw is not none %}{{ game.odds.draw }}{% else %}-{% endif %}
                                                    </div>
                                                </div>
                                                <div class="outcome-label">X</div>
                                            </div>
                                            
                                            <!-- Away Team -->
                                            <div class="team-column text-center">
                                                <div class="team-badge {% if game.away_win_is_profitable %}active-prediction{% endif %}">
                                                    <div class="team-name fw-bold mb-2" data-short="{{ 'true' if game.display_away_team|default(game.away_team|default('Away Team'))|length <= 15 else 'false' }}">{{ game.display_away_team|default(game.away_team|default('Away Team')) }}</div>
                                                    <div class="odds-badge {% if game.away_win_is_profitable %}highlighted-odds{% endif %}">
                                                        {% if game.odds.away is not none %}{{ game.odds.away }}{% else %}-{% endif %}
                                                    </div>
                                                </div>
                                                <div class="outcome-label">Away</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="prediction-timestamp small text-muted">
                            <i class="bi bi-clock-history me-1"></i>
                                        {% if game.prediction_timestamp or game.timestamp %}
                                            <span class="fw-medium">Predicted:</span> 
                                            {% if game.prediction_timestamp %}
                                                {% if game.prediction_timestamp is not string %}
                                                    {{ game.prediction_timestamp.strftime('%Y-%m-%d %H:%M') }}
                                                {% else %}
                                                    {% if 'T' in game.prediction_timestamp %}
                                                        {{ game.prediction_timestamp.split('T')[0] }} {{ game.prediction_timestamp.split('T')[1].split('.')[0].split('+')[0] }}
                                                    {% else %}
                                                        {{ game.prediction_timestamp }}
                                                    {% endif %}
                                                {% endif %}
                                            {% elif game.timestamp %}
                                                {% if game.timestamp is not string %}
                                                    {{ game.timestamp.strftime('%Y-%m-%d %H:%M') }}
                                                {% else %}
                                                    {% if 'T' in game.timestamp %}
                                                        {{ game.timestamp.split('T')[0] }} {{ game.timestamp.split('T')[1].split('.')[0].split('+')[0] }}
                                                    {% else %}
                                                        {{ game.timestamp }}
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                            {% else %}
                                No timestamp
                            {% endif %}
                                    </div>
                    </div>
                    
                                <!-- Prediction Data Column -->
                                <div class="col-md-7">
                                    <!-- All Predictions with Probabilities and EVs -->
                                    <div class="prediction-stats-container">
                                        <div class="table-responsive">
                                            <table class="table table-sm table-bordered mb-0">
                                                <thead class="table-primary text-dark">
                                                    <tr>
                                                        <th>Outcome</th>
                                                        <th>Probability</th>
                                                        <th>Odds</th>
                                                        <th>EV</th>
                                                        <th class="text-center">Profitable</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td class="fw-medium">Home Win</td>
                                                        <td>{{ (game.home_win_prob * 100)|round(1) }}%</td>
                                                        <td>{% if game.odds.home is not none %}{{ game.odds.home }}{% else %}-{% endif %}</td>
                                                        <td>{{ (game.home_win_ev * 100)|round(1) }}%</td>
                                                        <td class="text-center">{% if game.home_win_is_profitable %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="fw-medium">X</td>
                                                        <td>{{ (game.draw_prob * 100)|round(1) }}%</td>
                                                        <td>{% if game.odds.draw is not none %}{{ game.odds.draw }}{% else %}-{% endif %}</td>
                                                        <td>{{ (game.draw_ev * 100)|round(1) }}%</td>
                                                        <td class="text-center">{% if game.draw_is_profitable %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                                                    </tr>
                                                    <tr>
                                                        <td class="fw-medium">Away Win</td>
                                                        <td>{{ (game.away_win_prob * 100)|round(1) }}%</td>
                                                        <td>{% if game.odds.away is not none %}{{ game.odds.away }}{% else %}-{% endif %}</td>
                                                        <td>{{ (game.away_win_ev * 100)|round(1) }}%</td>
                                                        <td class="text-center">{% if game.away_win_is_profitable %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- History toggle button -->
                        {% if game.history_games and game.history_games|length > 0 %}
                        <button class="btn btn-sm btn-outline-primary toggle-history mt-2" 
                                data-game-id="{{ game.id }}_{{ game.model_name }}" 
                                data-history-count="{{ game.history_games|length }}">
                            <i class="bi bi-clock-history me-1"></i>
                            <span class="show-text">Show past predictions ({{ game.history_games|length }})</span>
                            <span class="hide-text d-none">Hide past predictions</span>
                        </button>
                        
                        <!-- Historical predictions container -->
                        <div id="history-container-{{ game.id }}_{{ game.model_name }}" class="history-container" style="display:none;">
                            {% for historical_game in game.history_games %}
                                <div class="card prediction-card history-prediction mb-3" data-index="{{ loop.index }}">
                                    <div class="card-header bg-info text-white py-2">
                                        <i class="bi bi-clock-history me-1"></i> Prediction from
                                        <strong class="ms-1">
                                            {% if historical_game.prediction_timestamp or historical_game.timestamp %}
                                                {% if historical_game.prediction_timestamp %}
                                                    {% if historical_game.prediction_timestamp is not string %}
                                                        {{ historical_game.prediction_timestamp.strftime('%Y-%m-%d %H:%M') }}
                                                    {% else %}
                                                        {% if 'T' in historical_game.prediction_timestamp %}
                                                            {{ historical_game.prediction_timestamp.split('T')[0] }} {{ historical_game.prediction_timestamp.split('T')[1].split('.')[0].split('+')[0] }}
                                                        {% else %}
                                                            {{ historical_game.prediction_timestamp }}
                                                        {% endif %}
                                                    {% endif %}
                                                {% elif historical_game.timestamp %}
                                                    {% if historical_game.timestamp is not string %}
                                                        {{ historical_game.timestamp.strftime('%Y-%m-%d %H:%M') }}
                                                    {% else %}
                                                        {% if 'T' in historical_game.timestamp %}
                                                            {{ historical_game.timestamp.split('T')[0] }} {{ historical_game.timestamp.split('T')[1].split('.')[0].split('+')[0] }}
                                                        {% else %}
                                                            {{ historical_game.timestamp }}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                            {% else %}
                                                Unknown date
                                            {% endif %}
                                        </strong>
                                    </div>
                                    
                                    <div class="card-body py-2">
                                        <!-- Historical odds display -->
                                        <div class="historical-odds mb-3">
                                            <h6 class="text-info fw-bold mb-2 small"><i class="bi bi-graph-up me-1"></i>Odds at Time of Prediction</h6>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="text-center px-2">
                                                    <div class="small fw-bold">{{ historical_game.display_home_team|default(historical_game.home_team) }}</div>
                                                    <span class="badge bg-light text-dark {% if historical_game.home_win_is_profitable %}badge-profitable{% endif %}">
                                                        {% if historical_game.odds.home is not none %}{{ historical_game.odds.home }}{% else %}-{% endif %}
                                                    </span>
                                                </div>
                                                <div class="text-center px-2">
                                                    <div class="small fw-bold">X</div>
                                                    <span class="badge bg-light text-dark {% if historical_game.draw_is_profitable %}badge-profitable{% endif %}">
                                                        {% if historical_game.odds.draw is not none %}{{ historical_game.odds.draw }}{% else %}-{% endif %}
                                                    </span>
                                                </div>
                                                <div class="text-center px-2">
                                                    <div class="small fw-bold">{{ historical_game.display_away_team|default(historical_game.away_team) }}</div>
                                                    <span class="badge bg-light text-dark {% if historical_game.away_win_is_profitable %}badge-profitable{% endif %}">
                                                        {% if historical_game.odds.away is not none %}{{ historical_game.odds.away }}{% else %}-{% endif %}
                                                    </span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- All Predictions with Probabilities and EVs -->
                                        <div class="prediction-stats-container">
                                            <div class="table-responsive">
                                                <table class="table table-sm table-bordered mb-0">
                                                    <thead class="table-info text-dark">
                                                        <tr>
                                                            <th>Outcome</th>
                                                            <th>Probability</th>
                                                            <th>Odds</th>
                                                            <th>EV</th>
                                                            <th class="text-center">Profitable</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td class="fw-medium">Home Win</td>
                                                            <td>{{ (historical_game.home_win_prob * 100)|round(1) }}%</td>
                                                            <td>{% if historical_game.odds.home is not none %}{{ historical_game.odds.home }}{% else %}-{% endif %}</td>
                                                            <td>{{ (historical_game.home_win_ev * 100)|round(1) }}%</td>
                                                            <td class="text-center">{% if historical_game.home_win_is_profitable %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="fw-medium">X</td>
                                                            <td>{{ (historical_game.draw_prob * 100)|round(1) }}%</td>
                                                            <td>{% if historical_game.odds.draw is not none %}{{ historical_game.odds.draw }}{% else %}-{% endif %}</td>
                                                            <td>{{ (historical_game.draw_ev * 100)|round(1) }}%</td>
                                                            <td class="text-center">{% if historical_game.draw_is_profitable %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                                                        </tr>
                                                        <tr>
                                                            <td class="fw-medium">Away Win</td>
                                                            <td>{{ (historical_game.away_win_prob * 100)|round(1) }}%</td>
                                                            <td>{% if historical_game.odds.away is not none %}{{ historical_game.odds.away }}{% else %}-{% endif %}</td>
                                                            <td>{{ (historical_game.away_win_ev * 100)|round(1) }}%</td>
                                                            <td class="text-center">{% if historical_game.away_win_is_profitable %}<i class="bi bi-check-circle-fill text-success"></i>{% else %}<i class="bi bi-x-circle-fill text-danger"></i>{% endif %}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                {% endfor %}
                
                <!-- Pagination -->
                <div class="d-flex justify-content-center mt-4">
                    {% if total_pages is defined and total_pages > 1 %}
                    <nav aria-label="Prediction pagination" class="mt-4">
                        <ul class="pagination pagination-sm justify-content-center">
                            <li class="page-item {% if not has_prev %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('all_predictions', page=page-1, per_page=per_page, league=selected_league, model_type=selected_model, prediction_type=selected_prediction, status=selected_status, result=selected_result, ev=selected_ev, lang=selected_language) }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            
                            {% set start_page = [1, page - 2]|max %}
                            {% set end_page = [start_page + 4, total_pages|default(1)]|min %}
                            {% set start_page = [end_page - 4, 1]|max %}
                            
                            {% if start_page > 1 %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('all_predictions', page=1, per_page=per_page, league=selected_league, model_type=selected_model, prediction_type=selected_prediction, status=selected_status, result=selected_result, ev=selected_ev, lang=selected_language) }}">1</a>
                                </li>
                                {% if start_page > 2 %}
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% endif %}
                            {% endif %}
                            
                            {% for p in range(start_page, end_page + 1) %}
                                <li class="page-item {% if p == page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('all_predictions', page=p, per_page=per_page, league=selected_league, model_type=selected_model, prediction_type=selected_prediction, status=selected_status, result=selected_result, ev=selected_ev, lang=selected_language) }}">{{ p }}</a>
                                </li>
                            {% endfor %}
                            
                            {% if end_page < total_pages|default(1) %}
                                {% if end_page < total_pages|default(1) - 1 %}
                                    <li class="page-item disabled"><span class="page-link">...</span></li>
                                {% endif %}
                                <li class="page-item">
                                    <a class="page-link" href="{{ url_for('all_predictions', page=total_pages|default(1), per_page=per_page, league=selected_league, model_type=selected_model, prediction_type=selected_prediction, status=selected_status, result=selected_result, ev=selected_ev, lang=selected_language) }}">{{ total_pages|default(1) }}</a>
                                </li>
                            {% endif %}
                            
                            <li class="page-item {% if not has_next %}disabled{% endif %}">
                                <a class="page-link" href="{{ url_for('all_predictions', page=page+1, per_page=per_page, league=selected_league, model_type=selected_model, prediction_type=selected_prediction, status=selected_status, result=selected_result, ev=selected_ev, lang=selected_language) }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                        </ul>
                    </nav>
                    {% endif %}
                </div>
                
            {% else %}
                {% if not loading %}
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    No predictions found matching your filters. Try adjusting your filter criteria.
                </div>
                {% endif %}
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Debug info
    console.log("Document loaded, initializing JS...");
    
    // Model dropdown selection handler
    const modelItems = document.querySelectorAll('.model-item');
    const modelTypeInput = document.getElementById('modelTypeInput');
    
    if (modelItems.length > 0 && modelTypeInput) {
        // Handle dropdown item clicks
        modelItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Update the hidden input field
                modelTypeInput.value = this.getAttribute('data-value');
                
                // Update the dropdown button text
                const dropdownButton = document.getElementById('modelFilterDropdown');
                if (dropdownButton) {
                    const buttonText = dropdownButton.querySelector('span');
                    if (buttonText) {
                        buttonText.textContent = this.textContent.trim() === 'All Models' ? 'All Models' : this.textContent.trim();
                    }
                }
                
                // Submit the form
                document.getElementById('filterForm').submit();
            });
        });
    }
    
    // Update data-short attribute for all team names
    document.querySelectorAll('.team-name').forEach(function(el) {
        // Change threshold to 15 characters
        if (el.textContent.trim().length <= 15) {
            el.setAttribute('data-short', 'true');
        } else {
            el.setAttribute('data-short', 'false');
        }
    });
    
    // If we're in loading state, load the actual predictions
    if (document.getElementById('loading-spinner')) {
        loadPredictions();
    }
    
    // Function to load predictions via AJAX
    function loadPredictions() {
        // Get current URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        
        // Set the init parameter to 0 to get actual predictions
        urlParams.delete('init');
        
        // Create the fetch URL
        const fetchUrl = window.location.pathname + '?' + urlParams.toString();
        
        // Show loading spinner
        const spinner = document.getElementById('loading-spinner');
        if (spinner) {
            spinner.style.display = 'block';
        }
        
        // Perform the fetch
        fetch(fetchUrl)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                // Extract the predictions container content from the response
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const predictionsContainer = doc.getElementById('predictions-container');
                const predictionCountDiv = doc.querySelector('.prediction-count'); // Get the count div from fetched HTML

                // Replace our container with the new one
                if (predictionsContainer) {
                    document.getElementById('predictions-container').innerHTML = predictionsContainer.innerHTML;
                }
                
                // Replace our count display with the new one
                const currentCountDiv = document.querySelector('.prediction-count');
                if (predictionCountDiv && currentCountDiv) {
                    currentCountDiv.innerHTML = predictionCountDiv.innerHTML; // Update the count display
                }
                    
                // Hide the loading spinner
                if (spinner) {
                    spinner.style.display = 'none';
                }
                
                // Reinitialize any necessary event handlers
                initPredictionCards();
                setupHistoryButtons();
            })
            .catch(error => {
                console.error('Error loading predictions:', error);
                if (spinner) {
                    spinner.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error loading predictions. Please try refreshing the page.
                        </div>
                    `;
                }
            });
    }
    
    // Function to initialize event handlers for prediction cards
    function initPredictionCards() {
        // Update data-short attribute for all team names
        document.querySelectorAll('.team-name').forEach(function(el) {
            if (el.textContent.trim().length <= 15) {
                el.setAttribute('data-short', 'true');
            } else {
                el.setAttribute('data-short', 'false');
            }
        });
    }
    
    // Function to set up history toggle buttons
    function setupHistoryButtons() {
        document.querySelectorAll('.toggle-history').forEach(function(button) {
            button.addEventListener('click', function() {
                const gameId = this.getAttribute('data-game-id');
                const historyContainer = document.getElementById('history-container-' + gameId);
                
                if (historyContainer) {
                    if (historyContainer.style.display === 'none' || !historyContainer.style.display) {
                        historyContainer.style.display = 'block';
                        this.querySelector('.show-text').classList.add('d-none');
                        this.querySelector('.hide-text').classList.remove('d-none');
                    } else {
                        historyContainer.style.display = 'none';
                        this.querySelector('.show-text').classList.remove('d-none');
                        this.querySelector('.hide-text').classList.add('d-none');
                    }
                }
            });
        });
    }
    
    // Add smooth loading transition
    const filterForm = document.getElementById('filterForm');
    if (filterForm) {
        filterForm.addEventListener('submit', function(e) {
            // Show loading indicator
            const predictionsContainer = document.getElementById('predictions-container');
            if (predictionsContainer) {
                predictionsContainer.innerHTML = `
                    <div class="text-center my-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-3">Loading predictions...</p>
                    </div>
                `;
            }
            
            // Add init=1 parameter to the form for fast initial load
            const initInput = document.createElement('input');
            initInput.type = 'hidden';
            initInput.name = 'init';
            initInput.value = '1';
            this.appendChild(initInput);
        });
    }
    
    // Add click handlers to pagination links for smooth transition
    document.querySelectorAll('.pagination .page-link').forEach(link => {
        link.addEventListener('click', function(e) {
            // Only process if the link is not disabled
            if (!this.parentElement.classList.contains('disabled')) {
                e.preventDefault();
                
                // Show loading indicator
                const predictionsContainer = document.getElementById('predictions-container');
                if (predictionsContainer) {
                    predictionsContainer.innerHTML = `
                        <div class="text-center my-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="mt-3">Loading predictions...</p>
                        </div>
                    `;
                }
                
                // Navigate to the page with init=1 parameter
                const url = new URL(this.href);
                url.searchParams.set('init', '1');
                window.location.href = url.toString();
            }
        });
    });

    // Initial setup of history buttons
    setupHistoryButtons();
});
</script>

<style>
.language-toggle {
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.language-toggle .btn {
    padding: 0.375rem 1rem;
    min-width: 100px;
}
/* Layout & General Styling */
.prediction-card {
    position: relative;
    margin-bottom: 15px;
    box-shadow: 0 3px 10px rgba(0,0,0,0.08);
    border-radius: 12px;
    overflow: hidden;
    width: 100%;
    border: 1px solid #e9ecef;
    transition: all 0.3s;
}

.prediction-card:hover {
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    transform: translateY(-2px);
    border-color: #dee2e6;
}

/* Team display */
.match-teams-container {
    border-radius: 8px;
    padding: 15px;
    background-color: #f8f9fa;
    border: 1px solid #e9ecef;
    margin-right: auto;
    width: 100%;
    overflow: hidden;
    box-sizing: border-box;
}

.teams-display {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 15px;
    align-items: stretch;
    width: 100%;
    max-width: 100%;
}

.team-column {
    min-width: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    width: 100%;
    box-sizing: border-box;
    padding: 0 2px;
}

.team-column.mx-2 {
    margin-left: 0 !important;
    margin-right: 0 !important;
}

.team-badge {
    padding: 10px 8px;
    border-radius: 8px;
    margin-bottom: 5px;
    background-color: white;
    border: 1px solid #e9ecef;
    transition: all 0.2s;
    width: 100%;
    min-height: 130px; /* Increased height */
    height: 130px; /* Increased height */
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    align-items: center;
    box-sizing: border-box;
    position: relative;
}

.team-name {
    font-size: 1rem; /* Larger font size */
    width: 100%;
    overflow: visible; /* Changed to visible to avoid cutoff */
    line-height: 1.4;
    word-break: break-word;
    margin: 0 auto 2px;
    text-align: center;
    padding: 0 5px;
    box-sizing: border-box;
    height: 4.2rem; /* Increased height */
    display: -webkit-box;
    -webkit-line-clamp: 3; /* Allow up to 3 lines */
    -webkit-box-orient: vertical;
}

/* Specific handling for short team names */
.team-name[data-short="true"] {
    white-space: normal;
    overflow: visible;
    text-overflow: clip;
    display: block;
    padding: 0 5px;
    font-size: 1.1rem; /* Larger font size */
    height: 1.4rem;
    line-height: 1.4;
}

.odds-badge {
    display: inline-block;
    padding: 5px 12px;
    border-radius: 20px;
    background-color: #e9ecef;
    color: #495057;
    font-weight: bold;
    font-size: 1rem;
    text-align: center;
    box-sizing: border-box;
    min-width: 55px;
    position: absolute;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
}

.active-prediction {
    background-color: #e6f7ed;
    border-color: #28a745;
}

.highlighted-odds {
    background-color: #28a745;
    color: white;
}

.badge-profitable {
    border: 2px solid #28a745 !important;
    color: #155724 !important;
    background-color: #d4edda !important;
}

.outcome-label {
    font-size: 0.75rem;
    color: #6c757d;
    font-weight: 500;
    margin-top: 4px;
}

/* Fix card body layout */
.card-body {
    padding: 1rem;
    overflow: hidden; /* Prevent content from spilling out */
}

.card-body .row {
    margin: 0;
    width: 100%;
    box-sizing: border-box;
    overflow: hidden;
}

.card-body .col-md-5 {
    width: 52% !important; /* Reduced from 55% to 52% */
    padding-left: 0;
    padding-right: 10px;
    flex: 0 0 52% !important; /* Reduced from 55% to 52% */
    max-width: 52% !important; /* Reduced from 55% to 52% */
    box-sizing: border-box;
}

.card-body .col-md-7 {
    width: 48% !important; /* Increased from 45% to 48% */
    padding-left: 10px;
    padding-right: 0;
    flex: 0 0 48% !important; /* Increased from 45% to 48% */
    max-width: 48% !important; /* Increased from 45% to 48% */
    box-sizing: border-box;
}

/* Responsive adjustments */
@media (max-width: 991px) {
    .card-body .col-md-5,
    .card-body .col-md-7 {
        width: 100%;
        flex: 0 0 100%;
        max-width: 100%;
        padding: 0;
    }
    
    .match-teams-container {
        margin-bottom: 15px;
    }
}

@media (max-width: 767.98px) {
    .teams-display {
        gap: 10px;
    }
    
    .team-badge {
        min-height: 110px;
        height: 110px;
        padding: 8px 5px;
    }
    
    .team-name {
        font-size: 0.95rem;
        padding: 0 3px;
        height: 4rem;
    }
    
    .team-name[data-short="true"] {
        font-size: 1rem;
        height: 1.4rem;
    }
    
    .odds-badge {
        font-size: 0.9rem;
        padding: 4px 10px;
        min-width: 50px;
        bottom: 12px;
    }
}

/* Historical odds display */
.historical-odds {
    background-color: #f0f8ff;
    border-radius: 8px;
    padding: 8px;
    border: 1px dashed #0dcaf0;
    overflow: hidden; /* Prevent content from spilling out */
}

/* History styling */
.history-prediction {
    border-left: 3px solid #0dcaf0;
    background-color: #f8f9fa;
    overflow: hidden;
}

.history-container {
    margin-left: 15px;
    margin-bottom: 20px;
    border-left: 2px dashed #dee2e6;
    padding-left: 15px;
    padding-top: 10px;
    overflow: hidden;
}

.toggle-history {
    transition: all 0.2s;
    margin-top: 8px;
    border-radius: 6px;
    font-weight: 500;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    padding: 5px 10px;
    font-size: 0.8rem;
    display: inline-block;
    float: right;
    width: auto !important;
}

.toggle-history:hover {
    transform: translateY(-1px);
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

/* Status indicators */
.prediction-correct {
    border-left: 4px solid #198754;
}

.prediction-incorrect {
    border-left: 4px solid #dc3545;
}

.result-badge {
    padding: 4px 8px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    display: inline-flex;
    align-items: center;
    white-space: nowrap;
}

.card-header > .d-flex > .d-flex {
    flex-shrink: 0;
}

/* Table styles */
.prediction-stats-container .table {
    font-size: 0.8rem; /* Slightly reduced from 0.85rem */
    width: 100%;
    table-layout: fixed;
    margin-bottom: 0.5rem;
}

.prediction-stats-container th,
.prediction-stats-container td {
    padding: 0.3rem 0.3rem; /* Slightly reduced padding */
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Set specific column widths */
.prediction-stats-container th:nth-child(1), /* OUTCOME */
.prediction-stats-container td:nth-child(1) {
    width: 23%; /* Reduced from 25% to 23% */
}

.prediction-stats-container th:nth-child(2), /* PROBABILITY */
.prediction-stats-container td:nth-child(2) {
    width: 23%; /* Reduced from 25% to 23% */
}

.prediction-stats-container th:nth-child(3), /* ODDS */
.prediction-stats-container td:nth-child(3) {
    width: 16%;
}

.prediction-stats-container th:nth-child(4), /* EV */
.prediction-stats-container td:nth-child(4) {
    width: 16%;
}

.prediction-stats-container th:nth-child(5), /* PROFITABLE */
.prediction-stats-container td:nth-child(5) {
    width: 22%; /* Increased from 18% to 22% */
    text-align: center;
}

/* Make profitable column visible */
.prediction-stats-container th:nth-child(5),
.prediction-stats-container td:nth-child(5) {
    padding-left: 0;
    padding-right: 0;
    min-width: 50px;
}

/* Make the icons in the profitable column not cut off */
.prediction-stats-container td:nth-child(5) i {
    font-size: 1rem;
    display: inline-block;
    width: auto;
}

/* Adjust the header text */
.prediction-stats-container thead th {
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0;
    padding: 0.3rem 0.2rem;
}

/* Ensure number columns align properly */
.prediction-stats-container td:nth-child(2), /* PROBABILITY */
.prediction-stats-container td:nth-child(3), /* ODDS */
.prediction-stats-container td:nth-child(4) { /* EV */
    text-align: right;
}

/* Filter panel */
.accordion-button:not(.collapsed) {
    background-color: #f8f9fa;
    color: #0d6efd;
}

.accordion-button:focus {
    box-shadow: none;
    border-color: rgba(0,0,0,.125);
}

/* Make labels and text more compact */
.form-select-sm, .btn-sm, .small {
    font-size: 0.85rem;
}

/* Make sure mobile is optimized */
@media (max-width: 767.98px) {
    .row {
        margin-left: -10px;
        margin-right: -10px;
    }
    
    .prediction-card .card-body {
        padding: 12px;
    }
    
    .prediction-stats-container {
        margin-top: 15px;
    }
    
    .team-column {
        padding: 0 2px;
    }
    
    .team-badge {
        padding: 6px 3px;
    }
    
    .team-name {
        font-size: 0.75rem;
        min-height: 2.2rem;
    }
    
    .odds-badge {
        font-size: 0.75rem;
        padding: 2px 6px;
    }
}

/* Ensure table container doesn't overflow */
.prediction-stats-container {
    overflow-x: hidden;
    max-width: 100%;
}

/* Make numbers not wrap and align right */
.prediction-stats-container td:nth-child(2), /* PROBABILITY */
.prediction-stats-container td:nth-child(3), /* ODDS */
.prediction-stats-container td:nth-child(4) { /* EV */
    text-align: right;
    white-space: nowrap;
}

/* Specific styling for the check/x icons */
.prediction-stats-container td:nth-child(5) i.bi-check-circle-fill {
    color: #28a745;
    font-size: 1.1rem;
}

.prediction-stats-container td:nth-child(5) i.bi-x-circle-fill {
    color: #dc3545;
    font-size: 1.1rem;
}

/* Make sure profitable header fits */
.prediction-stats-container th:nth-child(5) {
    font-size: 0.7rem;
    padding-left: 0;
    padding-right: 0;
}

.prediction-timestamp {
    margin-top: 5px;
    padding: 3px 0;
    font-size: 0.85rem !important;
    display: block;
    color: #666 !important;
}
</style>
{% endblock %} 